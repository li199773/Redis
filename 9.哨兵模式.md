# 哨兵模式

## 哨兵模式概述

（自动选主机的方式）
主从切换技术：当主机宕机后，需要手动把一台从（slave）服务器切换为主服务器，这就需要人工干预，费时费力，还回造成一段时间内服务不可用，所以推荐哨兵架构（Sentinel）来解决这个问题。
哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。

## 哨兵模式作用

1. 通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器
2. 当哨兵监测到Redis主机宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他服务器，修改配置文件，让他们换主机。

## 哨兵模式配置

|     IP地址     |     角色     |
| :------------: | :----------: |
| 192.168.81.100 | redis-master |
| 192.168.81.101 | redis-slave1 |
| 192.168.81.102 | redis-slave2 |

192.168.81.100,192.168.81.101,192.168.81.102相同配置

```
#允许后台启动
daemonize yes
#禁止保护模式
protected-mode no
#配置监听的主服务器，这里 sentinel monitor 代表监控
#mymaster代表服务器名称，可以自定义
#192.168.81.100代表监控的主服务器
#6379代表端口
#1代表只有两个或者两个以上的认为主服务器不可用的时候，才会做故障切换操作
sentinel monitor mymaster 192.168.81.100 6379 1
#sentinel auth-pass 定义服务的密码
#mymaster服务名称
#abcdefg Redis服务器密码
sentinel auth-pass mymaster xxxxxx
```

启动哨兵进程

```
./redis-sentinel ../sentinel.conf
启动Redis服务器进程
./redis-server ../redis.conf
```

只是这里要注意服务器启动的顺序，首先是主机（192.168.81.100）的 Redis 服务进程，然后启动从机的服务进程，最后启动 3 个哨兵的服务进程。

## 哨兵模式的其他配置项

| 配置项                           | 参数类型                     | 作用                                                         |
| -------------------------------- | ---------------------------- | ------------------------------------------------------------ |
| port                             | 整数                         | 启动哨兵进程端口                                             |
| dir                              | 文件夹目录                   | 哨兵进程服务临时文件夹，默认为 /tmp，要保证有可写入的权限    |
| sentinel down-after-milliseconds | <服务名称><亳秒数（整数）>   | 指定哨兵在监测 Redis 服务时，当 Redis 服务在一个亳秒数内都无法回答时，单个哨兵认为的主观下线时间，默认为 30000（30秒） |
| sentinel parallel-syncs          | <服务名称><服务器数（整数）> | 指定可以有多少 Redis 服务同步新的主机，一般而言，这个数字越小同步时间就越长，而越大，则对网络资源要求则越高 |
| sentinel failover-timeout        | <服务名称><亳秒数（整数）>   | 指定在故障切换允许的亳秒数，当超过这个亳秒数的时候，就认为 切换故障失败，默认为 3 分钟 |
| sentinel notification-script     | <服务名称><脚本路径>         | 指定 sentinel 检测到该监控的 redis 实例指向的实例异常时，调用的 报警脚本。该配置项可选，比较常用 |

## 宕机模拟

```
# 192.168.81.100
shutdown
# 等待一段时间之后192.168.81.101成为master
# 此时在恢复192.168.81.100查看状态
info replication
# 发现还是slave,也只能变成从机
```

## 哨兵模式总结

优点：
1.哨兵集群。基于主从复制模式，所有的主从配置优点，它都有
2.主从可以切换，故障可以转移，系统可用性就更好
3.哨兵模式是主从模式的升级，手动到自动，更完善
缺点：
1.Redis不好在线扩容，集群容量一旦达到上限，扩容麻烦
2.实现配置麻烦
