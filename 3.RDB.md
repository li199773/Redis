# RDB

## RDB机制

​    RDB 是 Redis DataBase 的缩写，即内存块照。因为Redis的数据时存在内存中的，当**服务器宕机**时，Redis中存储的数据就会丢失。这个时候就需要内存快照来恢复Redis中的数据了。快照就是在某一时刻，将Redis中的所有数据，以文件的形式存储起来。

## 全量快照

​    Redis 的数据都在内存中，为了提供所有数据的可靠性保证，它执行的是全量快照，也就是说，把内存中的所有数据都记录到磁盘中，这就类似于给 100 个人拍合影，把每一个人都拍进照片里。这样做的好处是，一次性记录了所有数据，一个都不少。

​    Redis提供了两个命令来生产全量的RDB文件，一个是 save ,另一个是 bgsave。
​    save：在主线程中执行，会导致阻塞；
​    bgsave：创建一个子进程，专门用于写入 RDB 文件，避免了主线程的阻塞，这也是 Redis RDB 文件生成的默认配置。

## 增量快照

   如果一直使用全量同步，一方面时间的推移，磁盘存储的快照文件会越来越多。另一方面如果频繁的进行全量同步，则需要主线线程频繁的fork出bgsvae线程，这样对Redis的性能是会产生影响的，并且也需要持续的对磁盘进行写操作。

   这个时候，我们可以采用另一只同步方式：增量快照。所谓增量快照，就是指，做了一次全量快照后，后续的快照只对修改的数据进行快照记录，这样可以避免每次全量快照的开销。在第一次做完全量快照后，T1 和 T2 时刻如果再做快照，我们只需要将被修改的数据写入快照文件就行。但是，这么做的前提是，我们需要记住哪些数据被修改了。

## RDB配置

1. SNAPSHOTTING

   ```
   save 3600 1
   save 300 100
   save 60 10000
   save 30 2
   服务器在900秒之内，对数据库进行了至少1次修改
   服务器在300秒之内，对数据库进行了至少10次修改　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　
   服务器在60秒之内，对数据库进行了至少10000次修改。
   这里配置了30秒之内，对数据库进行了至少2次修改就触发RDB。
   ```

2. 开启保存出错停止写入功能（默认开启）

   ```
   如果RDB快照持久化操作被激活（至少一个条件被激活）并且持久化操作失败，Redis则会停止接受更新操作。
   stop-writes-on-bgsave-error yes
   ```

3. 数据压缩（默认开启）

   ```
   rdbcompression yes
   ```

4. RDB文件校验（默认开启）

   ```
   会让格式更加耐攻击，但是当存储或者加载rbd文件的时候会有一个10%左右的性能下降
   rdbchecksum yes
   ```

5. 指定本地数据库文件名，一般采用默认的 dump.rdb

   ```
   dbfilename dump.rdb
   ```

## redis 小结

1.save规制满足情况下，会自动触发rdb规则，生成文件
2.执行flushall命令，也会触发rdb规则，生成文件
3.退出redis，也会触发rdb规则，生成文件
4.重启redis的时候，会自动读取dir目录下的rdb文件，自行恢复数据

优点：
1、适合大规模数据恢复
2、对数据完整性要求不高

缺点：
1、需要一定时间间隔进行操作,如果redis意外宕机了，最后一次修改数据就没有了！
2、备份时占用内存，因为Redis 在备份时会独立创建一个fork进程，将数据写入到一个临时文件（此时内存中的数据是原来的两倍哦），最后再将临时文件替换之前的备份文件。
所以Redis 的持久化和数据的恢复要选择在夜深人静的时候执行是比较合理的。
